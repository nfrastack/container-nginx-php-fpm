# SPDX-FileCopyrightText: Â© 2025 Nfrastack <code@nfrastack.com>
#
# SPDX-License-Identifier: MIT

ENABLE_PHP_FPM=${ENABLE_PHP_FPM:-"TRUE"}
PHPFPM_CONTAINER_MODE=${PHPFPM_CONTAINER_MODE:-"nginx-php-fpm"}
PHP_VERSION="$(php -v 2>/dev/null | grep "^PHP " | head -n 1 | awk '{print $2}')"
PHP_BASE="${PHP_VERSION%.*}"

PHP_ENABLE_CREATE_SAMPLE_PHP=${PHP_ENABLE_CREATE_SAMPLE_PHP:-"TRUE"}
PHP_HIDE_X_POWERED_BY=${PHP_HIDE_X_POWERED_BY:-"TRUE"}
PHP_KITCHENSINK=${PHP_KITCHENSINK:-"FALSE"}

PHP_MEMORY_LIMIT=${PHP_MEMORY_LIMIT:-"128M"}
PHP_POST_MAX_SIZE=${PHP_POST_MAX_SIZE:-"2G"}
PHP_TIMEOUT=${PHP_TIMEOUT:-"180"}
PHP_UPLOAD_MAX_SIZE=${PHP_UPLOAD_MAX_SIZE:-"2G"}

PHPFPM_ENV_TEMP=${PHPFPM_ENV_TEMP:-"/tmp"}
PHPFPM_ENV_TMP=${PHPFPM_ENV_TMP:-"/tmp"}
PHPFPM_ENV_TMPDIR=${PHPFPM_ENV_TMPDIR:-"/tmp"}
PHPFPM_ENV_PATH=${PHPFPM_ENV_PATH:-"/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"}

if [ -f "/usr/sbin/unitd" ] ; then
    PHP_WEBROOT=${PHP_WEBROOT:-"${UNIT_WEBROOT}"}
    PHPFPM_POOL_DEFAULT_LISTEN_UNIX_GROUP=${PHPFPM_POOL_DEFAULT_LISTEN_UNIX_GROUP:-"${UNIT_GROUP}"}
    PHPFPM_POOL_DEFAULT_LISTEN_UNIX_USER=${PHPFPM_POOL_DEFAULT_LISTEN_UNIX_USER:-"${UNIT_USER}"}
    PHPFPM_POOL_DEFAULT_USER=${PHPFPM_POOL_DEFAULT_USER:-"${UNIT_USER}"}
    PHPFPM_POOL_DEFAULT_GROUP=${PHPFPM_POOL_DEFAULT_GROUP:-"${UNIT_GROUP}"}
fi

if [ -f "/usr/sbin/nginx" ] ; then
    PHP_WEBROOT=${PHP_WEBROOT:-"${NGINX_WEBROOT}"}
    PHPFPM_POOL_DEFAULT_LISTEN_UNIX_GROUP=${PHPFPM_POOL_DEFAULT_LISTEN_UNIX_GROUP:-"${NGINX_GROUP}"}
    PHPFPM_POOL_DEFAULT_LISTEN_UNIX_USER=${PHPFPM_POOL_DEFAULT_LISTEN_UNIX_USER:-"${NGINX_USER}"}
    PHPFPM_USER=${PHPFPM_USER:-"${NGINX_USER}"}
    PHPFPM_GROUP=${PHPFPM_GROUP:-"${NGINX_GROUP}"}
fi

PHPFPM_POOL_DEFAULT_CATCH_WORKERS_OUTPUT=${PHPFPM_POOL_DEFAULT_CATCH_WORKERS_OUTPUT-"true"}
PHPFPM_POOL_DEFAULT_ENABLE_LOG=${PHPFPM_POOL_DEFAULT_ENABLE_LOG:-"TRUE"}
PHPFPM_POOL_DEFAULT_PING_PATH=${PHPFPM_POOL_DEFAULT_PING_PATH-"/ping"}
PHPFPM_POOL_DEFAULT_DISPLAY_ERRORS=${PHPFPM_POOL_DEFAULT_DISPLAY_ERRORS-"TRUE"}
PHPFPM_POOL_DEFAULT_LISTEN_IP=${PHPFPM_POOL_DEFAULT_LISTEN_IP:-"0.0.0.0"}
PHPFPM_POOL_DEFAULT_LISTEN_TYPE=${PHPFPM_POOL_DEFAULT_LISTEN_TYPE:-"unix"}
PHPFPM_POOL_DEFAULT_LISTEN_PORT=${PHPFPM_POOL_DEFAULT_LISTEN_PORT:-"9000"}
PHPFPM_POOL_DEFAULT_LISTEN_TCP_IP=${PHPFPM_POOL_DEFAULT_LISTEN_TCP_IP:-"${PHPFPM_POOL_DEFAULT_LISTEN_IP}"}
PHPFPM_POOL_DEFAULT_LISTEN_TCP_IP_ALLOWED=${PHPFPM_POOL_DEFAULT_LISTEN_TCP_IP_ALLOWED:-"127.0.0.1"}
PHPFPM_POOL_DEFAULT_LISTEN_TCP_PORT=${PHPFPM_POOL_DEFAULT_LISTEN_TCP_PORT:-"${PHPFPM_POOL_DEFAULT_LISTEN_PORT}"}
PHPFPM_POOL_DEFAULT_LISTEN_UNIX_SOCKET=${PHPFPM_POOL_DEFAULT_LISTEN_UNIX_SOCKET:-"/var/lib/php-fpm/run/default.sock"}

PHPFPM_POOL_DEFAULT_ENV=${PHPFPM_POOL_DEFAULT_ENV:-"PATH,TEMP,TMP,TMPDIR"}
PHPFPM_POOL_DEFAULT_LOG_ACCESS_FILE=${PHPFPM_POOL_DEFAULT_LOG_ACCESS_FILE:-"default-access.log"}
PHPFPM_POOL_DEFAULT_LOG_ACCESS_FORMAT=${PHPFPM_POOL_DEFAULT_LOG_ACCESS_FORMAT:-"default"}
PHPFPM_POOL_DEFAULT_LOG_PATH=${PHPFPM_POOL_DEFAULT_LOG_PATH:-"/logs/php-fpm/"}
PHPFPM_POOL_DEFAULT_MAX_CHILDREN=${PHPFPM_MAX_CHILDREN:-"75"}
PHPFPM_POOL_DEFAULT_MAX_INPUT_NESTING_LEVEL=${PHPFPM_MAX_INPUT_NESTING_LEVEL:-"256"}
PHPFPM_POOL_DEFAULT_MAX_INPUT_VARS=${PHPFPM_MAX_INPUT_VARS:-"10000"}
PHPFPM_POOL_DEFAULT_MAX_REQUESTS=${PHPFPM_MAX_REQUESTS:-"0"}
PHPFPM_POOL_DEFAULT_MAX_SPARE_SERVERS=${PHPFPM_MAX_SPARE_SERVERS:-"3"}
PHPFPM_POOL_DEFAULT_MEMORY_LIMIT=${PHPFPM_MEMORY_LIMIT:-"${PHP_MEMORY_LIMIT}"}
PHPFPM_POOL_DEFAULT_MIN_SPARE_SERVERS=${PHPFPM_MIN_SPARE_SERVERS:-"1"}
PHPFPM_POOL_DEFAULT_OUTPUT_BUFFER_SIZE=${PHPFPM_OUTPUT_BUFFER_SIZE:-"0"}
PHPFPM_POOL_DEFAULT_POST_MAX_SIZE=${PHPFPM_POOL_POST_MAX_SIZE:-"${PHP_POST_MAX_SIZE}"}
PHPFPM_POOL_DEFAULT_PROCESS_IDLE_TIMEOUT=${PHPFPM_PROCESS_IDLE_TIMEOUT:-"10s"}
PHPFPM_POOL_DEFAULT_PROCESS_MANAGER=${PHPFPM_PROCESS_MANAGER:-"dynamic"}
PHPFPM_POOL_DEFAULT_START_SERVERS=${PHPFPM_START_SERVERS:-"2"}
PHPFPM_POOL_DEFAULT_STATUS_PATH=${PHPFPM_STATUS_PATH:-"/php-fpm_status"}
PHPFPM_POOL_DEFAULT_TIMEOUT=${PHPFPM_TIMEOUT:-"${PHP_TIMEOUT}"}
PHPFPM_POOL_DEFAULT_UPLOAD_MAX_SIZE=${PHPFPM_UPLOAD_MAX_SIZE:-"${PHP_UPLOAD_MAX_SIZE}"}

PHPFPM_LOG_ERROR_FILE=${PHPFPM_LOG_ERROR_FILE:-"error.log"}
PHPFPM_LOG_ERROR_PATH=${PHPFPM_LOG_ERROR_PATH:-"/var/log/php-fpm/"}
PHPFPM_LOG_LEVEL=${PHPFPM_LOG_LEVEL:-"notice"}
PHPFPM_LOG_LIMIT=${PHPFPM_LOG_LIMIT:-"3072"}

PHP_MODULE_APC_SHM_SIZE=${PHP_MODULE_APC_SHM_SIZE:-"128M"}
PHP_MODULE_APC_TTL=${PHP_MODULE_APC_TTL:-"7200"}
PHP_MODULE_OPCACHE_INTERNED_STRINGS_BUFFER=${PHP_MODULE_OPCACHE_INTERNED_STRINGS_BUFFER:-"8"}
PHP_MODULE_OPCACHE_JIT_BUFFER_SIZE=${PHP_MODULE_OPCACHE_JIT_BUFFER_SIZE:-"50M"}
PHP_MODULE_OPCACHE_JIT_MODE=${PHP_MODULE_OPCACHE_JIT_MODE:-"1255"}
PHP_MODULE_OPCACHE_MAX_ACCELERATED_FILES=${PHP_MODULE_OPCACHE_MAX_ACCELERATED_FILES:-"10000"}
PHP_MODULE_OPCACHE_MAX_FILE_SIZE=${PHP_MODULE_OPCACHE_MAX_FILE_SIZE:-"0"}
PHP_MODULE_OPCACHE_MAX_WASTED_PERCENTAGE=${PHP_MODULE_OPCACHE_MAX_WASTED_PERCENTAGE:-"5"}
PHP_MODULE_OPCACHE_MEM_SIZE=${PHP_MODULE_OPCACHE_MEM_SIZE:-"128"}
PHP_MODULE_OPCACHE_OPTIMIZATION_LEVEL=${PHP_MODULE_OPCACHE_OPTIMIZATION_LEVEL:-"0x7FFFBFF"}
PHP_MODULE_OPCACHE_REVALIDATE_FREQ=${PHP_MODULE_OPCACHE_REVALIDATE_FREQ:-"2"}
PHP_MODULE_OPCACHE_SAVE_COMMENTS=${PHP_MODULE_OPCACHE_SAVE_COMMENTS:-"1"}
PHP_MODULE_OPCACHE_VALIDATE_TIMESTAMPS=${PHP_MODULE_OPCACHE_VALIDATE_TIMESTAMPS:-"1"}

#Xdebug 2
PHP_MODULE_XDEBUG_PROFILER_PATH=${PHP_MODULE_XDEBUG_PROFILER_PATH:-"/logs/xdebug/"}
PHP_MODULE_XDEBUG_PROFILER_ENABLE=${PHP_MODULE_XDEBUG_PROFILER_ENABLE:-"0"}
PHP_MODULE_XDEBUG_PROFILER_ENABLE_TRIGGER=${PHP_MODULE_XDEBUG_PROFILER_ENABLE_TRIGGER:-"0"}
PHP_MODULE_XDEBUG_REMOTE_AUTOSTART=${PHP_MODULE_XDEBUG_REMOTE_AUTOSTART:-"1"}
PHP_MODULE_XDEBUG_REMOTE_CONNECT_BACK=${PHP_MODULE_XDEBUG_REMOTE_CONNECT_BACK:-"0"}
PHP_MODULE_XDEBUG_REMOTE_ENABLE=${PHP_MODULE_XDEBUG_REMOTE_ENABLE:-"1"}
PHP_MODULE_XDEBUG_REMOTE_HANDLER=${PHP_MODULE_XDEBUG_REMOTE_HANDLER:-"dbgp"}
PHP_MODULE_XDEBUG_REMOTE_HOST=${PHP_MODULE_XDEBUG_REMOTE_HOST:-"127.0.0.1"}
PHP_MODULE_XDEBUG_REMOTE_PORT=${PHP_MODULE_XDEBUG_REMOTE_PORT:-"9090"}

#Xdebug 3
PHP_MODULE_XDEBUG_MODE=${PHP_MODULE_XDEBUG_MODE:-"develop"}
PHP_MODULE_XDEBUG_START_WITH_REQUEST=${PHP_MODULE_XDEBUG_START_WITH_REQUEST:-"default"}
PHP_MODULE_XDEBUG_DISCOVER_CLIENT_HOST=${PHP_MODULE_XDEBUG_DISCOVER_CLIENT_HOST:-"default"}
PHP_MODULE_XDEBUG_CLIENT_HOST=${PHP_MODULE_XDEBUG_CLIENT_HOST:-"127.0.0.1"}
PHP_MODULE_XDEBUG_CLIENT_PORT=${PHP_MODULE_XDEBUG_CLIENT_PORT:-"9003"}

if [ "${PHP_BASE:0:1}" != "8" ] ; then
    PHP_MODULE_ENABLE_JSON=TRUE
fi

if var_true "${PHP_MODULE_ENABLE_MEMCACHED}" || var_true "${PHP_MODULE_ENABLE_REDIS}"; then
    PHP_MODULE_ENABLE_IGBINARY=TRUE
    PHP_MODULE_ENABLE_MSGPACK=TRUE
fi

get_defaults_advanced